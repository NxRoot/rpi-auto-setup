#!/bin/bash
# Toggle console auto-login for Raspberry Pi (Debian-based)
# Works with systemd on Raspberry Pi OS, Ubuntu, etc.

set -e
value=${3:-on}
USER=$(who -m | awk '{ print $1 }')
SERVICE="getty@tty1.service"
OVERRIDE_DIR="/etc/systemd/system/${SERVICE}.d"
OVERRIDE_FILE="${OVERRIDE_DIR}/autologin.conf"

if [ -f "$OVERRIDE_FILE" ]; then
    sudo rm -f $OVERRIDE_FILE
    sudo systemctl --quiet set-default multi-user.target
    sudo mkdir -p $OVERRIDE_DIR
    sudo cat > $OVERRIDE_FILE << EOF
[Service]
ExecStart=
ExecStart=-/sbin/agetty --autologin $USER --noclear %I \$TERM
EOF
fi

if [ "$value" = "on" ]; then
    echo "Enabled auto-login for user '${USER}'..."
    sudo systemctl enable ${SERVICE}
else
    echo "Disabled auto-login for user '${USER}'..."
    sudo systemctl disable ${SERVICE}
fi

echo "Please reboot your device for changes to take effect."
